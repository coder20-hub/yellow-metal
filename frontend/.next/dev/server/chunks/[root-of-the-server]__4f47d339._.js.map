{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/koust/Downloads/code/frontend/lib/mongodb.ts"],"sourcesContent":["import { MongoClient, Db, ObjectId } from 'mongodb';\r\n\r\nconst uri = process.env.MONGODB_URI || process.env.DATABASE_URL || 'mongodb://localhost:27017';\r\nconst dbName = process.env.MONGODB_DB_NAME || process.env.DATABASE_NAME || 'yellowmetal';\r\n\r\nconst options = {};\r\n\r\nlet client: MongoClient;\r\nlet clientPromise: Promise<MongoClient>;\r\n\r\nif (process.env.NODE_ENV === 'development') {\r\n  // In development mode, use a global variable so that the value\r\n  // is preserved across module reloads caused by HMR (Hot Module Replacement).\r\n  let globalWithMongo = global as typeof globalThis & {\r\n    _mongoClientPromise?: Promise<MongoClient>;\r\n  };\r\n\r\n  if (!globalWithMongo._mongoClientPromise) {\r\n    client = new MongoClient(uri, options);\r\n    globalWithMongo._mongoClientPromise = client.connect();\r\n  }\r\n  clientPromise = globalWithMongo._mongoClientPromise;\r\n} else {\r\n  // In production mode, it's best to not use a global variable.\r\n  client = new MongoClient(uri, options);\r\n  clientPromise = client.connect();\r\n}\r\n\r\nexport async function getDatabase(): Promise<Db> {\r\n  const client = await clientPromise;\r\n  return client.db(dbName);\r\n}\r\n\r\nexport { ObjectId };\r\nexport default clientPromise;\r\n\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW,IAAI,QAAQ,GAAG,CAAC,YAAY,IAAI;AACnE,MAAM,SAAS,QAAQ,GAAG,CAAC,eAAe,IAAI,QAAQ,GAAG,CAAC,aAAa,IAAI;AAE3E,MAAM,UAAU,CAAC;AAEjB,IAAI;AACJ,IAAI;AAEJ,wCAA4C;IAC1C,+DAA+D;IAC/D,6EAA6E;IAC7E,IAAI;IAIJ,IAAI,CAAC,gBAAgB,mBAAmB,EAAE;QACxC,SAAS,IAAI,sHAAW,CAAC,KAAK;QAC9B,gBAAgB,mBAAmB,GAAG,OAAO,OAAO;IACtD;IACA,gBAAgB,gBAAgB,mBAAmB;AACrD;;AAMO,eAAe;IACpB,MAAM,SAAS,MAAM;IACrB,OAAO,OAAO,EAAE,CAAC;AACnB;;uCAGe"}},
    {"offset": {"line": 110, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/koust/Downloads/code/frontend/app/api/crm/analytics/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { getDatabase, ObjectId } from '@/lib/mongodb';\r\nimport jwt from 'jsonwebtoken';\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';\r\n\r\nasync function verifySuperAdmin(request: NextRequest): Promise<{ valid: boolean }> {\r\n  try {\r\n    const token = request.headers.get('authorization')?.replace('Bearer ', '');\r\n    if (!token) return { valid: false };\r\n\r\n    const decoded = jwt.verify(token, JWT_SECRET) as any;\r\n    \r\n    const db = await getDatabase();\r\n    const usersCollection = db.collection('crm_users');\r\n    const user = await usersCollection.findOne({ _id: new ObjectId(decoded.userId) });\r\n\r\n    if (!user || user.role !== 'superadmin') {\r\n      return { valid: false };\r\n    }\r\n\r\n    return { valid: true };\r\n  } catch {\r\n    return { valid: false };\r\n  }\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const auth = await verifySuperAdmin(request);\r\n    if (!auth.valid) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'Unauthorized - Superadmin only' },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const db = await getDatabase();\r\n    const applicationsCollection = db.collection('loan_applications');\r\n\r\n    // Get all applications\r\n    const applications = await applicationsCollection.find({}).toArray();\r\n\r\n    // Total applications\r\n    const totalApplications = applications.length;\r\n\r\n    // Total loan amount\r\n    const totalLoanAmount = applications.reduce((sum, app) => sum + (app.loanAmount || 0), 0);\r\n    const avgLoanAmount = totalApplications > 0 ? totalLoanAmount / totalApplications : 0;\r\n\r\n    // Pincode-wise statistics\r\n    const pincodeStats: Record<string, { count: number; totalAmount: number }> = {};\r\n    applications.forEach(app => {\r\n      const pincode = app.pincode || extractPincode(app.branch) || 'Unknown';\r\n      if (!pincodeStats[pincode]) {\r\n        pincodeStats[pincode] = { count: 0, totalAmount: 0 };\r\n      }\r\n      pincodeStats[pincode].count++;\r\n      pincodeStats[pincode].totalAmount += app.loanAmount || 0;\r\n    });\r\n\r\n    const pincodeBreakdown = Object.entries(pincodeStats)\r\n      .map(([pincode, stats]) => ({\r\n        pincode,\r\n        count: stats.count,\r\n        totalAmount: stats.totalAmount,\r\n        avgAmount: stats.totalAmount / stats.count,\r\n      }))\r\n      .sort((a, b) => b.count - a.count);\r\n\r\n    // Applications over time (last 30 days)\r\n    const thirtyDaysAgo = new Date();\r\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n    \r\n    const dailyApplications: Record<string, number> = {};\r\n    applications\r\n      .filter(app => new Date(app.createdAt) >= thirtyDaysAgo)\r\n      .forEach(app => {\r\n        const date = new Date(app.createdAt).toISOString().split('T')[0];\r\n        dailyApplications[date] = (dailyApplications[date] || 0) + 1;\r\n      });\r\n\r\n    const dailyTrend = Object.entries(dailyApplications)\r\n      .map(([date, count]) => ({ date, count }))\r\n      .sort((a, b) => a.date.localeCompare(b.date));\r\n\r\n    // Loan amount distribution\r\n    const amountRanges = [\r\n      { range: '0-50000', min: 0, max: 50000, count: 0 },\r\n      { range: '50000-100000', min: 50000, max: 100000, count: 0 },\r\n      { range: '100000-250000', min: 100000, max: 250000, count: 0 },\r\n      { range: '250000-500000', min: 250000, max: 500000, count: 0 },\r\n      { range: '500000+', min: 500000, max: Infinity, count: 0 },\r\n    ];\r\n\r\n    applications.forEach(app => {\r\n      const amount = app.loanAmount || 0;\r\n      const range = amountRanges.find(r => amount >= r.min && amount < r.max);\r\n      if (range) {\r\n        range.count++;\r\n      }\r\n    });\r\n\r\n    // Branch-wise statistics\r\n    const branchStats: Record<string, { count: number; totalAmount: number }> = {};\r\n    applications.forEach(app => {\r\n      const branch = app.branch || 'Unknown';\r\n      if (!branchStats[branch]) {\r\n        branchStats[branch] = { count: 0, totalAmount: 0 };\r\n      }\r\n      branchStats[branch].count++;\r\n      branchStats[branch].totalAmount += app.loanAmount || 0;\r\n    });\r\n\r\n    const branchBreakdown = Object.entries(branchStats)\r\n      .map(([branch, stats]) => ({\r\n        branch,\r\n        count: stats.count,\r\n        totalAmount: stats.totalAmount,\r\n      }))\r\n      .sort((a, b) => b.count - a.count)\r\n      .slice(0, 10); // Top 10 branches\r\n\r\n    // Monthly comparison\r\n    const monthlyData: Record<string, { count: number; totalAmount: number }> = {};\r\n    applications.forEach(app => {\r\n      const month = new Date(app.createdAt).toISOString().slice(0, 7); // YYYY-MM\r\n      if (!monthlyData[month]) {\r\n        monthlyData[month] = { count: 0, totalAmount: 0 };\r\n      }\r\n      monthlyData[month].count++;\r\n      monthlyData[month].totalAmount += app.loanAmount || 0;\r\n    });\r\n\r\n    const monthlyTrend = Object.entries(monthlyData)\r\n      .map(([month, stats]) => ({\r\n        month,\r\n        count: stats.count,\r\n        totalAmount: stats.totalAmount,\r\n      }))\r\n      .sort((a, b) => a.month.localeCompare(b.month))\r\n      .slice(-12); // Last 12 months\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      analytics: {\r\n        overview: {\r\n          totalApplications,\r\n          totalLoanAmount,\r\n          avgLoanAmount,\r\n        },\r\n        pincodeBreakdown,\r\n        dailyTrend,\r\n        amountDistribution: amountRanges,\r\n        branchBreakdown,\r\n        monthlyTrend,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error('Analytics error:', error);\r\n    return NextResponse.json(\r\n      { success: false, error: 'Internal server error' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nfunction extractPincode(branch: string): string | null {\r\n  const match = branch.match(/\\b\\d{6}\\b/);\r\n  return match ? match[0] : null;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}